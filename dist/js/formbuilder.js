/*! jQuery.formbuilder */
dust.onLoad=function(a,b){$.ajax("templates/"+a+".tpl",{success:function(a){b(void 0,a)},error:function(a,c){b(c,void 0)}})},function(a){var b=function(a){return new c(a)},c=function(a){if(!_.has(a,"targets")||!_.isObject(a.targets)||0===a.targets.length)throw new Error("Invalid or missing target element(s)");if(!_.has(a,"save_url")||!_.isString(a.save_url)||""===a.save_url.trim())throw new Error("Invalid or missing save url");var b={form_id:"frmb-"+_.now(),startingModel:!1,targets:!1,save_url:!1,field_types:[{key:"text",label:"Text",schema:{name:!1,label:"",required:!1}},{key:"textarea",label:"Textarea",schema:{name:!1,label:"",required:!1}},{key:"select",label:"Select",template:"choices",schema:{name:!1,label:"",required:!1,choices:[]},choiceSchema:{selected:!1,label:""}},{key:"radio",label:"Radio",template:"choices",schema:{name:!1,label:"",required:!1,choices:[]},choiceSchema:{selected:!1,label:""}},{key:"checkbox",label:"Checkbox",template:"choices",schema:{name:!1,label:"",required:!1,choices:[]},choiceSchema:{selected:!1,label:""}}]};return this._opts=_.assign(b,a),function(a){var b=a._opts.targets;a.render(),_.isObject(a._opts.startingModel)&&(a._model=a._opts.startingModel,_.each(a._model,function(b){var c=a.getFieldTypeByName(b.type);a.addFormElementEditor(c,b)})),b.on("change",".frmb-add-elem",function(){var b=$(this).val();a.addFormElementEditor(a.getFieldTypeByName(b)),$(this).val("")}),b.on("click",".frmb-add-choice",function(b){b.preventDefault();var c=$(this),d=c.parents(".frmb-group").last(),e=d.attr("id"),f=a.getFieldTypeByName(a._model[e].type);return a.appendFieldToFormElementEditor(d,f,a._model[e]),!1}),b.on("click",".frmb-remove",function(b){b.preventDefault();var c=$(this),d=c.parents(".frmb-group:eq(0)"),e=d.attr("id");return a.removeModel(e),d.remove(),!1}),b.on("keyup","input[type=text]",function(){var b=$(this),c=b.parents(".frmb-group").last(),d=c.attr("id"),e=b.attr("name").replace(d+"_","");a.setModelValue(d,e,b.val())}),b.on("change","input[type=checkbox]",function(){var b=$(this),c=b.parents(".frmb-group").last(),d=c.attr("id"),e=b.attr("name").replace(d+"_","");a.setModelValue(d,e,b.is(":checked"))}),b.on("submit",".frmb-save",function(b){return b.preventDefault(),a.save(),!1})}(this),this};c.prototype={_opts:!1,_model:{},render:function(){var a=this,b={field_types:this._opts.field_types};dust.render("base",b,function(b,c){a._opts.targets.append(c)})},getFieldTypeByName:function(a){return _.find(this._opts.field_types,{key:a})},addFormElementEditor:function(a,b){var c=this;if(!_.isObject(a))throw new Error("Failed to add form element editor: Invalid field object");var d=a.key+"_"+_.now();_.has(b,"name")&&_.isString(b.name)?d=b.name:_.isString(a.name)&&(d=a.name),_.isObject(b)||(c._model[d]=_.assign(a.schema,{name:d,type:a.key}),b=c._model[d]);var e={name:d,model:b};e=_.assign(e,a),dust.render("element-base",e,function(d,f){var g=$(f);return c._opts.targets.find(".frmb-group:last").after(g),$("#"+e.name+"_label").attr("required",!0),_.has(b,"choices")?void _.each(b.choices,function(d,e){c.appendFieldToFormElementEditor(g,a,b,d,e)}):void c.appendFieldToFormElementEditor(g,a,b)})},appendFieldToFormElementEditor:function(a,b,c,d,e){if(_.has(b,"template")&&_.has(c,"choices")&&_.isArray(c.choices)){_.isObject(d)||(d=_.clone(b.choiceSchema),c.choices.push(d));var f={name:c.name,model:d};e=_.isNumber(e)?e:c.choices.length,f.name+="_choices."+e,dust.render(b.template,f,function(b,c){a.append(c)})}},setModelValue:function(a,b,c){var d=!1;if(b.indexOf(".")>-1&&(d=b.split("."),b=d[0]),!_.isObject(this._model[a]))throw new Error("Model has no entry for "+a);if(!_.has(this._model[a],b))throw new Error("Invalid schema field "+b+" for model "+a);this.getFieldTypeByName(this._model[a].type);if("choices"===b){var e=_.parseInt(d[1]);if(!_.has(this._model[a][b][e],d[2]))throw new Error("Invalid choice schema field "+d[2]+" for model "+a);return void(this._model[a][b][e][d[2]]=c)}this._model[a][b]=c},removeModel:function(a){if(a.indexOf(".")>-1){var b=a.replace(/.*_/,""),c=b.split("."),d=_.parseInt(c[1]);return a=a.replace("_"+b,""),void delete this._model[a][c[0]][d]}delete this._model[a]},save:function(){var a={form_id:this._opts.form_id,model:this._model};$.ajax({url:this._opts.save_url,data:JSON.stringify(a),contentType:"application/json",type:"post",success:function(){}})}},a.formbuilder=b}(this);